<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>„Åã„Åö„Çè„Åë„Ç≤„Éº„É†</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #f0f8ff;
    }
    #title, #game {
      margin-top: 30px;
    }
    #numberButtons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      justify-content: center;
      max-width: 300px;
      margin: 0 auto 20px;
    }
    #numberButtons button {
      font-size: 24px;
      padding: 20px 0;
      width: 100%;
      border-radius: 8px;
      background-color: #eee;
      border: 2px solid #ccc;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #numberButtons button:hover {
      background-color: #ddd;
    }
    #numberButtons button.selected {
      background-color: #3399ff;
      color: white;
      border-color: #3399ff;
    }
    .basket {
      width: 280px;
      height: 280px;
      border: 3px solid #444;
      display: inline-block;
      vertical-align: top;
      margin: 10px 30px;
      padding: 15px;
      border-radius: 16px;
      background-color: #f9f9f9;
    }
    .basket h3 {
      font-size: 20px;
      margin: 0 0 10px 0;
    }
    .apple {
      width: 40px;
      height: 40px;
      background-color: red;
      border-radius: 50%;
      display: inline-block;
      margin: 5px;
      touch-action: none;
    }
    #completeOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 48px;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    canvas#fireworksCanvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 999;
      pointer-events: none;
    }
    #hanamaruImg {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px; /* ‚Üê Â§ß„Åç„Åï„ÇíÂ§âÊõ¥ */
      z-index: 1100;
      pointer-events: none;
      user-select: none;
    }
    #message {
      font-size: 18px;
      height: 1.5em;
      margin-top: 8px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="title">
    <h1>„Åã„Åö„Çè„Åë„Ç≤„Éº„É†</h1>
    <p>Êï∞Â≠ó„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºà3ÔΩû10Ôºâ</p>
    <div id="numberButtons"></div>
    <button id="startBtn" disabled>„Ç≤„Éº„É†„Çπ„Çø„Éº„Éà</button>
  </div>

  <div id="game" style="display: none;">
    <h2 id="gameTitle"></h2>
    <div id="appleContainer"></div>
    <div>
      <div id="basket1" class="basket" ondrop="drop(event)" ondragover="allowDrop(event)">
        <h3>„Å≤„Å†„Çä„ÅÆ„Åã„Åî</h3>
      </div>
      <div id="basket2" class="basket" ondrop="drop(event)" ondragover="allowDrop(event)">
        <h3>„Åø„Åé„ÅÆ„Åã„Åî</h3>
      </div>
    </div>
    <p><button id="checkBtn">„Åì„Åü„Åà„ÅÇ„Çè„Åõ</button></p>
    <p id="message"></p>
  </div>

  <div id="completeOverlay">„Åú„Çì„ÇÇ„Çì„Åõ„ÅÑ„Åã„ÅÑÔºÅüéâ</div>
  <canvas id="fireworksCanvas"></canvas>
  <img src="img/hanamaru.png" id="hanamaruImg" alt="Ëä±‰∏∏" />

  <script>
    const numberButtonsDiv = document.getElementById('numberButtons');
    const startBtn = document.getElementById('startBtn');
    const titleDiv = document.getElementById('title');
    const gameDiv = document.getElementById('game');
    const gameTitle = document.getElementById('gameTitle');
    const appleContainer = document.getElementById('appleContainer');
    const basket1 = document.getElementById('basket1');
    const basket2 = document.getElementById('basket2');
    const checkBtn = document.getElementById('checkBtn');
    const messageP = document.getElementById('message');
    const completeOverlay = document.getElementById('completeOverlay');
    const fireworksCanvas = document.getElementById('fireworksCanvas');
    const ctx = fireworksCanvas.getContext('2d');
    const hanamaruImg = document.getElementById('hanamaruImg');

    let selectedNumber = 0;
    let patterns = [];
    let currentPatternIndex = 0;
    let animationId;
    let fireworks = [];
    let clearedPairs = [];

    window.addEventListener('resize', () => {
      fireworksCanvas.width = window.innerWidth;
      fireworksCanvas.height = window.innerHeight;
    });
    fireworksCanvas.width = window.innerWidth;
    fireworksCanvas.height = window.innerHeight;

    for (let i = 3; i <= 10; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.dataset.num = i;
      btn.addEventListener('click', () => {
        selectedNumber = Number(btn.dataset.num);
        document.querySelectorAll('#numberButtons button').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        startBtn.disabled = false;
      });
      numberButtonsDiv.appendChild(btn);
    }

    startBtn.addEventListener('click', () => {
      titleDiv.style.display = 'none';
      gameDiv.style.display = 'block';
      generatePatterns();
      startGameRound();
    });

    function generatePatterns() {
      patterns = [];
      clearedPairs = [];
      for (let i = 1; i <= selectedNumber / 2; i++) {
        const j = selectedNumber - i;
        if (!patterns.some(p => (p[0] === j && p[1] === i))) {
          patterns.push([i, j]);
        }
      }
    }

    function startGameRound() {
      if (patterns.length === 0) {
        appleContainer.innerHTML = '';
        basket1.innerHTML = '';
        basket2.innerHTML = '';
        gameTitle.textContent = '';
        messageP.textContent = '';
        completeOverlay.style.display = 'flex';
        startFireworks();
        setTimeout(() => {
          completeOverlay.style.display = 'none';
          stopFireworks();
          resetGame();
        }, 3000);
        return;
      }
      currentPatternIndex = Math.floor(Math.random() * patterns.length);
      gameTitle.textContent = `„ÇÇ„Çì„Å†„ÅÑÔºö${selectedNumber} „ÅØ„ÅÑ„Åè„Å§„Å®„ÅÑ„Åè„Å§„Å´„Çè„Åë„Çâ„Çå„ÇãÔºü`;
      appleContainer.innerHTML = '';
      basket1.innerHTML = '<h3>„Å≤„Å†„Çä„ÅÆ„Åã„Åî</h3>';
      basket2.innerHTML = '<h3>„Åø„Åé„ÅÆ„Åã„Åî</h3>';
      for (let i = 0; i < selectedNumber; i++) {
        const apple = document.createElement('div');
        apple.className = 'apple';
        apple.draggable = true;
        apple.id = 'apple' + i;
        apple.addEventListener('dragstart', drag);
        apple.addEventListener('touchstart', touchStart, { passive: false });
        appleContainer.appendChild(apple);
      }
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function drag(ev) {
      ev.dataTransfer.setData('text', ev.target.id);
    }

    function drop(ev) {
      ev.preventDefault();
      let target = ev.target;
      if (target.tagName === 'H3') target = target.parentNode;
      const data = ev.dataTransfer.getData('text');
      const apple = document.getElementById(data);
      target.appendChild(apple);
    }

    checkBtn.addEventListener('click', () => {
      const count1 = basket1.querySelectorAll('.apple').length;
      const count2 = basket2.querySelectorAll('.apple').length;
      const userPair = count1 < count2 ? [count1, count2] : [count2, count1];
      const alreadyCleared = clearedPairs.some(p => p[0] === userPair[0] && p[1] === userPair[1]);
      if (alreadyCleared) {
        messageP.textContent = '„Åì„ÅÆ„Åè„Åø„ÅÇ„Çè„Åõ„ÅØ„ÇÇ„ÅÜ„Åõ„ÅÑ„Åã„ÅÑ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Å§„Åé„ÅÆ„ÇÇ„Çì„Å†„ÅÑ„Å∏„Åô„Åô„Åø„Åæ„Åó„Çá„ÅÜÔºÅ';
        return;
      }

      const idx = patterns.findIndex(p => p[0] === userPair[0] && p[1] === userPair[1]);

      if (idx >= 0) {
        messageP.textContent = `„Åõ„ÅÑ„Åã„ÅÑÔºÅ„Äå${userPair[0]} „Å® ${userPair[1]}„Äç„ÅÆ„Åè„Åø„ÅÇ„Çè„Åõ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ`;
        showHanamaruImage();
        patterns.splice(idx, 1);
        clearedPairs.push(userPair);
        setTimeout(() => {
          messageP.textContent = '';
          startGameRound();
        }, 1200);
      } else {
        messageP.textContent = '„Å°„Åå„ÅÑ„Åæ„Åô„ÄÇ„ÇÇ„ÅÜ„ÅÑ„Å°„Å©„Åã„Çì„Åå„Åà„Å¶„Åø„Å¶„Å≠„ÄÇ';
      }
    });

    function resetGame() {
      gameDiv.style.display = 'none';
      titleDiv.style.display = 'block';
      startBtn.disabled = true;
      selectedNumber = 0;
      document.querySelectorAll('#numberButtons button').forEach(b => b.classList.remove('selected'));
    }

    let touchedApple = null;

    function touchStart(ev) {
      ev.preventDefault();
      touchedApple = ev.target;
      document.addEventListener('touchmove', touchMove, { passive: false });
      document.addEventListener('touchend', touchEnd);
    }

    function touchMove(ev) {
      if (!touchedApple) return;
      const touch = ev.touches[0];
      touchedApple.style.position = 'absolute';
      touchedApple.style.left = (touch.clientX - 20) + 'px';
      touchedApple.style.top = (touch.clientY - 20) + 'px';
      touchedApple.style.zIndex = 1000;
    }

    function touchEnd(ev) {
      if (!touchedApple) return;
      const baskets = [basket1, basket2];
      const touch = ev.changedTouches[0];
      baskets.forEach(basket => {
        const rect = basket.getBoundingClientRect();
        if (touch.clientX > rect.left && touch.clientX < rect.right && touch.clientY > rect.top && touch.clientY < rect.bottom) {
          basket.appendChild(touchedApple);
        }
      });
      touchedApple.style.position = 'static';
      touchedApple.style.left = '';
      touchedApple.style.top = '';
      touchedApple.style.zIndex = '';
      touchedApple = null;
      document.removeEventListener('touchmove', touchMove);
      document.removeEventListener('touchend', touchEnd);
    }

    function startFireworks() {
      fireworksCanvas.width = window.innerWidth;
      fireworksCanvas.height = window.innerHeight;
      animationId = requestAnimationFrame(animate);
    }

    function stopFireworks() {
      cancelAnimationFrame(animationId);
      ctx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
      fireworks = [];
    }

    function animate() {
      ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
      ctx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
      if (Math.random() < 0.05) createFirework();
      fireworks.forEach(f => f.update());
      fireworks = fireworks.filter(f => f.alpha > 0);
      animationId = requestAnimationFrame(animate);
    }

    function createFirework() {
      const x = Math.random() * fireworksCanvas.width;
      const y = Math.random() * fireworksCanvas.height / 2;
      for (let i = 0; i < 20; i++) fireworks.push(new Particle(x, y));
    }

    class Particle {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        const angle = Math.random() * 2 * Math.PI;
        const speed = Math.random() * 5 + 2;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.alpha = 1;
        this.color = `hsl(${Math.random() * 360}, 100%, 85%)`;
      }
      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.alpha -= 0.02;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, 2 * Math.PI);
        ctx.fillStyle = this.color;
        ctx.globalAlpha = this.alpha;
        ctx.fill();
        ctx.globalAlpha = 1;
      }
    }

function showHanamaruImage() {
  hanamaruImg.style.display = 'block';
  setTimeout(() => {
    hanamaruImg.style.display = 'none';
  }, 3000); // ‚Üê ‚òÖË°®Á§∫ÊôÇÈñì„Çí3Áßí„Å´Ë®≠ÂÆö
}


  </script>
</body>
</html>
